# Ensemble Attack Network with StegaStamp

## Environmental Setup
```
# git clone https://github.com/aiiu-lab/DeepRobustWatermark
# cd DeepRobustWatermark/
# cd StegaStamp/
```
```
# conda create --name stegastamp python=3.10
# conda activate stegastamp
# conda install pytorch torchvision torchaudio pytorch-cuda=11.8 -c pytorch -c nvidia
# pip install -r requirement_stega.txt
```

## Training
Single-GPU and multi-GPU training. (For multi-GPU training, please refer to [Accelerate](https://huggingface.co/docs/accelerate/basic_tutorials/notebook)).
```
# cd scripts
# bash autoencoder.sh
```

## Evaluation
### Embedding and Decoding Watermarks
```
# cd scripts
# bash embedding.sh
# bash detecting.sh
```

### WAVES Benchmark
For the environmental setup, please refer to [WAVES](https://github.com/umd-huang-lab/WAVES).

Please refer to [Accelerate](https://huggingface.co/docs/accelerate/package_reference/cli) before running the code.

Downolad and put [kl-f16.zip](https://github.com/aiiu-lab/DeepRobustWatermark/releases/tag/kl-f16.zip) under the folder feature_extractors.

```
# git clone https://github.com/XuandongZhao/WatermarkAttacker
# cd WatermarkAttacker/
# pip install -e .
```
```
# cd scripts
# bash eval_distortion.sh
# bash eval_adversarial.sh
# bash eval_regeneration.sh
```

If you suffer from "ImportError: cannot import name 'VectorQuantizer2". Replace quantize.py on your machine (taming-transformers/taming/modules/vqvae/quantize,py) with this [file](https://github.com/CompVis/taming-transformers/blob/master/taming/modules/vqvae/quantize.py).

### Manipulation Attacks
Using [InstructPix2Pix](https://github.com/timothybrooks/instruct-pix2pix) or [StyleRes](https://github.com/hamzapehlivan/StyleRes) to attack watermarked images generated by ```embedding.sh```. After the attacks, use ```detecting.sh``` to extract watermarks from the distorted images and calculate bit accuracy.

### Pre-trained Weights
Pre-trained weigths can be download at [here](https://github.com/aiiu-lab/DeepRobustWatermark/releases/tag/checkpoints.zip).